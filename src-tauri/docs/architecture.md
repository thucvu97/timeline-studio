# Архитектура Backend

## Обзор

Tauri backend построен на Rust и предоставляет нативные десктопные возможности для приложения Timeline Studio. 

## Основные архитектурные компоненты

### Модульная структура

1. **Модуль файловой системы** (`src/filesystem.rs`)
   - Файловые операции: чтение, запись, поиск
   - Управление директориями
   - Получение метаданных файлов
   - Кроссплатформенная обработка путей

2. **Медиа модуль** (`src/media/`)
   - `metadata.rs` - Анализ медиафайлов на основе FFmpeg
   - `ffmpeg.rs` - Интеграция и валидация FFmpeg
   - `types.rs` - Структуры данных для медиа

3. **Видео компилятор** (`src/video_compiler/`)
   - `commands.rs` - Обработчики команд Tauri
   - `cache.rs` - LRU кеш для превью и метаданных
   - `frame_extraction.rs` - Извлечение кадров для различных целей
   - `preview.rs` - Генерация превью видео
   - `builder.rs` - Построение команд FFmpeg
   - `progress.rs` - Отслеживание прогресса рендеринга
   - `schema.rs` - Определения схемы проекта

4. **Видео сервер** (`src/video_server/`)
   - HTTP сервер для стриминга видео
   - Поддержка Range запросов
   - Конфигурация CORS
   - Регистрация видеофайлов

## Управление состоянием

### Принципы
- Используйте `Arc<RwLock<T>>` для разделяемого изменяемого состояния
- Реализуйте `Default` для типов состояния
- Держите состояние минимальным и сфокусированным

### Пример структуры состояния
```rust
#[derive(Default)]
pub struct AppState {
    video_cache: Arc<RwLock<VideoCache>>,
    render_queue: Arc<RwLock<RenderQueue>>,
    server_state: Arc<RwLock<ServerState>>,
}
```

## Безопасность и возможности

### Система возможностей Tauri

Приложение использует систему возможностей Tauri для безопасности:

1. **Доступ к файловой системе**
   - Чтение/запись в выбранные пользователем директории
   - Управление файлами проекта
   - Импорт медиафайлов

2. **Shell команды**
   - Выполнение FFmpeg для обработки видео
   - Запросы системной информации

3. **HTTP клиент**
   - API коммуникации
   - Проверка обновлений

4. **Управление окнами**
   - Поддержка нескольких окон
   - Пользовательские элементы управления окнами

## Структура команд

Команды Tauri следуют этому паттерну:

```rust
#[tauri::command]
pub async fn command_name(
    state: State<'_, AppState>,
    param1: String,
    param2: Option<i32>
) -> Result<ReturnType, String> {
    // Реализация
}
```

## Сервисный слой

### Принципы проектирования
1. **Разделение ответственности** - Каждый сервис отвечает за одну область
2. **Dependency Injection** - Сервисы получают зависимости через конструктор
3. **Async/Await** - Все операции ввода-вывода асинхронные
4. **Обработка ошибок** - Использование Result<T, VideoCompilerError>

### Основные сервисы
- **RenderService** - Рендеринг видео
- **PreviewService** - Генерация превью
- **CacheService** - Управление кешем
- **MediaService** - Работа с медиафайлами
- **ProjectService** - Управление проектами

## Интеграция с Frontend

### Коммуникация
- Команды Tauri для вызова backend функционала
- События для уведомлений frontend
- Сериализация через Serde JSON

### Обработка прогресса
```rust
window.emit("render-progress", ProgressUpdate {
    percent: 0.75,
    message: Some("Кодирование видео...".to_string()),
})?;
```

## Производительность

### Стратегии оптимизации
1. **Кеширование** - LRU кеши для часто используемых данных
2. **Ленивая загрузка** - Загрузка данных по требованию
3. **Стриминг** - Обработка больших файлов по частям
4. **Параллелизм** - Использование tokio для асинхронных операций

### Мониторинг
- Метрики производительности через систему мониторинга
- Отслеживание использования памяти
- Логирование медленных операций