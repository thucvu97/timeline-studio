# Архитектура Timeline Studio

## Обзор

Timeline Studio - это профессиональное приложение для редактирования видео, построенное на современном технологическом стеке, объединяющем Rust (бэкенд) и React (фронтенд) через Tauri.

## Технологический стек

### Фронтенд
- **Фреймворк**: Next.js 15 с React 19
- **Язык**: TypeScript (строгий режим)
- **Управление состоянием**: XState v5 для сложных конечных автоматов
- **UI компоненты**: shadcn/ui (примитивы Radix UI)
- **Стилизация**: Tailwind CSS v4
- **Тестирование**: Vitest + Testing Library

### Бэкенд
- **Среда выполнения**: Tauri v2 (Rust)
- **Обработка видео**: интеграция с FFmpeg
- **ML/AI**: ONNX Runtime для моделей YOLO
- **База данных**: файловое хранилище проектов
- **Кэширование**: LRU кэш + кэш файловой системы

## Диаграмма архитектуры

```
┌─────────────────────────────────────────────────────────────┐
│                        Фронтенд (React)                       │
├─────────────────────────────────────────────────────────────┤
│                     Функциональные модули                     │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ Timeline │ │  Video   │ │ Browser  │ │  Export  │ ...   │
│  │          │ │  Player  │ │          │ │          │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
├─────────────────────────────────────────────────────────────┤
│                    Управление состоянием                      │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐        │
│  │ XState       │ │ React        │ │ Context      │        │
│  │ Machines     │ │ Hooks        │ │ Providers    │        │
│  └──────────────┘ └──────────────┘ └──────────────┘        │
├─────────────────────────────────────────────────────────────┤
│                     Tauri IPC мост                           │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                      Бэкенд (Rust)                           │
├─────────────────────────────────────────────────────────────┤
│                     Основные модули                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │  Media   │ │  Video   │ │Recognition│ │  Video   │       │
│  │          │ │ Compiler │ │  (YOLO)  │ │  Server  │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
├─────────────────────────────────────────────────────────────┤
│                   Внешние сервисы                            │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                    │
│  │  FFmpeg  │ │   ONNX   │ │  File    │                    │
│  │          │ │  Runtime │ │  System  │                    │
│  └──────────┘ └──────────┘ └──────────┘                    │
└─────────────────────────────────────────────────────────────┘
```

## Основные принципы проектирования

### 1. Архитектура на основе функций
Каждая функция является самодостаточной и содержит:
- Компоненты
- Хуки
- Сервисы (XState машины)
- Типы
- Утилиты
- Тесты

### 2. Разделение ответственности
- **Фронтенд**: отрисовка UI, взаимодействие с пользователем, представление состояния
- **Бэкенд**: тяжелые вычисления, файловый ввод/вывод, обработка видео, ML инференс
- **IPC**: минимальная передача данных, командное взаимодействие

### 3. Производительность прежде всего
- GPU ускорение для обработки видео
- Эффективные стратегии кэширования
- Ленивая загрузка и виртуализация
- Web Workers для тяжелых вычислений

### 4. Типобезопасность
- TypeScript в строгом режиме
- Система типов Rust
- Общие определения типов между фронтендом и бэкендом

## Ключевые компоненты

### Функции фронтенда

#### Таймлайн
- Центральный компонент редактирования
- Поддержка многодорожечности
- Управление клипами
- Предпросмотр в реальном времени

#### Видеоплеер
- Пользовательский плеер с точным контролем кадров
- Аппаратное ускорение
- Поддержка множества кодеков

#### Система эффектов
- Обработка эффектов на основе CSS
- GPU-ускоренные фильтры
- Более 30 типов переходов
- Предпросмотр в реальном времени

#### Система экспорта
- Поддержка множества форматов
- Предустановки качества
- Аппаратное кодирование
- Отслеживание прогресса

### Модули бэкенда

#### Видео компилятор
- Интеграция с FFmpeg
- Поддержка GPU кодирования
- Сложные графы фильтров
- Многопроходный рендеринг

#### Модуль распознавания
- Интеграция YOLO v11
- Обнаружение объектов/лиц
- Анализ сцен
- Пакетная обработка

#### Управление медиа
- Работа с файлами
- Извлечение метаданных
- Генерация миниатюр
- Система предпросмотра

## Поток данных

### Загрузка проекта
```
Пользователь выбирает проект → Фронтенд читает файл проекта → 
Парсинг данных таймлайна → Инициализация конечных автоматов → 
Загрузка ссылок на медиа → Запрос миниатюр от бэкенда →
Отображение в UI
```

### Экспорт видео
```
Пользователь нажимает экспорт → Сбор состояния таймлайна → 
Преобразование в схему бэкенда → Отправка в видео компилятор →
Обработка FFmpeg → Обновления прогресса через события →
Сохранение выходного файла
```

### Поток распознавания
```
Извлечение кадров → Отправка в YOLO процессор →
Обнаружение объектов/лиц → Агрегация результатов →
Сохранение в кэше распознавания → Обновление UI
```

## Управление состоянием

### XState машины
- **timeline-machine**: Состояние редактирования таймлайна
- **player-machine**: Управление воспроизведением
- **browser-state-machine**: Состояние файлового браузера
- **app-settings-machine**: Настройки приложения
- **modal-machine**: Состояние модальных окон

### Провайдеры контекста
- TimelineProvider
- PlayerProvider
- SettingsProvider
- ThemeProvider

## Оптимизации производительности

### Фронтенд
- React.memo для дорогостоящих компонентов
- useMemo/useCallback для вычислений
- Виртуальная прокрутка для длинных списков
- Web Workers для вычислений таймлайна

### Бэкенд
- GPU ускорение (NVENC, QuickSync и т.д.)
- LRU кэширование для превью
- Параллельная обработка где возможно
- Эффективное управление памятью

## Вопросы безопасности

- Изолированный доступ к файлам через Tauri
- Нет прямого доступа к файловой системе из фронтенда
- Валидация IPC команд
- Безопасное хранилище для пользовательских настроек

## Архитектура развертывания

### Десктопное приложение
- Tauri пакеты для каждой платформы
- Интеграция автообновлений
- Подпись кода для дистрибуции
- Нативная интеграция с ОС

### Структура файлов
```
timeline-studio/
├── src/              # Исходный код фронтенда
├── src-tauri/        # Исходный код бэкенда
├── public/           # Статические ресурсы
├── docs/             # Документация
├── ai-gen-docs/      # AI-сгенерированная документация
└── dist/             # Результаты сборки
```

## Будущие направления развития

### Масштабируемость
- Система плагинов для расширений
- Поддержка облачного рендеринга
- Совместное редактирование
- Мобильное приложение-компаньон

### Производительность
- WebGPU для продвинутых эффектов
- WASM для вычислительно-интенсивных задач
- Улучшенная поддержка потоковой передачи
- Прокси-рабочий процесс для 4K/8K

---

*Для подробной документации по модулям см. отдельные файлы README в каталоге каждого модуля.*