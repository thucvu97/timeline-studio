# Timeline (Таймлайн)

## Обзор

Таймлайн — это центральный компонент редактора, отвечающий за размещение и управление медиафайлами на временной шкале. Он позволяет создавать и редактировать дорожки, размещать на них клипы, управлять их позицией и длительностью, а также синхронизироваться с плеером для воспроизведения.

Особенностью таймлайна в Timeline Editor является его организация по секторам (датам) с шкалой реального времени дня. Это позволяет точно синхронизировать видео, снятые в одно и то же время с разных камер, и обеспечивает удобную навигацию по временным меткам.

## Состояние

Таймлайн управляется через машину состояний `timelineMachine`, которая контролирует:

- Создание и управление дорожками
- Размещение и редактирование клипов
- Историю изменений (undo/redo)
- Синхронизацию с плеером
- Текущее время и активную дорожку

## Основные функции

- Управление дорожками (треками)
- Работа с секциями по датам
- Управление видеофрагментами
- Поддержка undo/redo
- Горячие клавиши для управления
- Синхронизация с медиаплеером

## Структура компонентов

### Основные компоненты

- `timeline/` - компоненты таймлайна
  - `timeline.tsx` - корневой компонент
  - `timeline-bar.tsx` - панель управления
  - `timeline-scale.tsx` - шкала времени
  - `timeline-controls.tsx` - элементы управления
  - `track/` - компоненты треков
    - `video-track.tsx` - видео трек
    - `audio-track.tsx` - аудио трек
    - `track-header.tsx` - заголовок трека
    - `track-content.tsx` - содержимое трека
  - `clip/` - компоненты клипов
    - `video-clip.tsx` - видео клип
    - `audio-clip.tsx` - аудио клип
    - `clip-controls.tsx` - элементы управления клипом

### Дополнительные компоненты

- `icons/` - иконки интерфейса
  - `play-icon.tsx` - иконка воспроизведения
  - `pause-icon.tsx` - иконка паузы
  - `record-icon.tsx` - иконка записи
  - `stop-icon.tsx` - иконка остановки
  - `volume-icon.tsx` - иконка громкости
  - `fullscreen-icon.tsx` - иконка полноэкранного режима

### Файлы состояния

- `machines/timeline-machine.ts` - машина состояний
- `providers/timeline-provider.tsx` - провайдер контекста

## Описание машины состояний

`timelineMachine` управляет временной шкалой проекта. Она отвечает за создание и управление треками, размещение клипов, работу с историей изменений (undo/redo) и синхронизацию с медиаплеером. Машина также контролирует активный трек и текущее время на таймлайне.

### Контекст timelineMachine

- `tracks: Track[]` - все треки
- `activeTrackId: string | null` - ID активного трека
- `activeVideo: MediaFile | null` - активное видео
- `currentTime: number` - текущее время
- `currentRealTime: Date` - текущее реальное время (дата и время дня)
- `history: TimelineState[]` - история состояний для undo/redo
- `historyIndex: number` - текущий индекс в истории
- `sections: TimelineSection[]` - секции по датам
- `activeSectionId: string | null` - ID активной секции (даты)
- `isRecording: boolean` - состояние записи
- `timeScale: number` - масштаб шкалы времени
- `timeFormat: '12h' | '24h'` - формат отображения времени

### Методы timelineMachine

#### Управление треками

- `setTracks` - установка треков
- `setActiveTrack` - установка активного трека
- `addTrack` - добавление трека
- `removeTrack` - удаление трека
- `updateTrack` - обновление трека
- `setVideo` - установка видео на треке
- `removeVideo` - удаление видео с трека

#### Управление историей

- `undo` - отмена действия
- `redo` - повтор действия

#### Навигация

- `seek` - перемещение по временной шкале
- `seekToRealTime` - перемещение к определенному реальному времени

#### Управление секторами

- `setSections` - установка секций
- `setActiveSection` - установка активной секции
- `addSection` - добавление новой секции
- `removeSection` - удаление секции
- `updateSection` - обновление секции
- `mergeSections` - объединение секций

#### Настройки отображения

- `setTimeScale` - установка масштаба шкалы времени
- `setTimeFormat` - установка формата отображения времени

## Типы треков

### Видео трек

Видео трек предназначен для размещения видеоклипов. Он поддерживает:

- Размещение видеоклипов
- Перемещение клипов по треку
- Изменение длительности клипов
- Обрезку клипов
- Применение эффектов и переходов

### Аудио трек

Аудио трек предназначен для размещения аудиоклипов. Он поддерживает:

- Размещение аудиоклипов
- Перемещение клипов по треку
- Изменение длительности клипов
- Обрезку клипов
- Управление громкостью

## Работа с секторами и шкалой времени

Таймлайн в Timeline Editor организован по секторам, которые соответствуют датам съемки, и имеет шкалу реального времени дня.

### Секторы (даты)

Секторы представляют собой разделы таймлайна, соответствующие определенным датам. Каждый сектор содержит:

- Дату (год, месяц, день)
- Начальное и конечное время дня
- Набор треков с клипами, относящимися к этой дате

Секторы позволяют организовать материал хронологически и обеспечивают удобную навигацию по проекту.

### Шкала времени дня

Шкала времени дня отображает реальное время (часы, минуты, секунды) вместо относительного времени от начала проекта. Это обеспечивает:

- Точную синхронизацию видео, снятых одновременно с разных камер
- Удобную навигацию по временным меткам
- Возможность быстро найти нужный момент по времени съемки
- Автоматическое выравнивание клипов по времени создания

### Управление секторами

#### Добавление нового сектора

Процесс добавления нового сектора включает следующие шаги:

1. **Выбор даты** - пользователь выбирает дату для нового сектора
2. **Определение временного диапазона** - устанавливается начальное и конечное время дня
3. **Создание сектора** - система создает новый сектор с уникальным идентификатором
4. **Инициализация треков** - в новом секторе создаются пустые треки или копируются из шаблона
5. **Активация сектора** - новый сектор становится активным для редактирования

Пример кода для добавления сектора:

```typescript
// В компоненте таймлайна
const { addSection } = useTimeline();

const handleAddSection = () => {
  const date = new Date(); // Текущая дата или выбранная пользователем

  addSection({
    id: `section-${Date.now()}`,
    date: date,
    startTime: new Date(date.setHours(0, 0, 0, 0)), // Начало дня
    endTime: new Date(date.setHours(23, 59, 59, 999)), // Конец дня
    tracks: [], // Пустые треки или копия из шаблона
    name: date.toLocaleDateString(), // Имя сектора (по умолчанию - дата)
  });
};
```

#### Переключение между секторами

- Выбор сектора из списка доступных секторов
- Автоматическое сохранение состояния предыдущего сектора
- Загрузка треков и клипов выбранного сектора
- Обновление шкалы времени в соответствии с временным диапазоном сектора

#### Объединение секторов

- Выбор секторов для объединения
- Определение общего временного диапазона
- Объединение треков и клипов с сохранением их временных позиций
- Создание нового сектора или обновление существующего

#### Настройка отображения шкалы времени

- Изменение масштаба (zoom in/out)
- Переключение между 12-часовым и 24-часовым форматом
- Настройка отображения временных меток (каждый час, полчаса, 10 минут и т.д.)
- Настройка цветовой схемы для разных периодов дня (утро, день, вечер, ночь)

## Работа с клипами

### Видео клип

Видео клип представляет собой медиафайл, размещенный на таймлайне. Он имеет:

- Начальное время на таймлайне (соответствует реальному времени дня)
- Длительность
- Начальное время в исходном файле
- Конечное время в исходном файле
- Эффекты и переходы
- Метаданные о времени создания (для автоматической синхронизации)

### Аудио клип

Аудио клип аналогичен видео клипу, но предназначен для аудиофайлов.

## Взаимодействие с другими компонентами

### Взаимодействие с браузером

- Получение медиафайлов для размещения на таймлайне
- Обновление метаданных при изменении файлов

### Взаимодействие с плеером

- Синхронизация времени воспроизведения
- Управление воспроизведением
- Обновление текущего времени

## Примеры использования

### Добавление трека

```typescript
// В компоненте таймлайна
const { addTrack } = useTimeline();

const handleAddTrack = () => {
  addTrack({
    id: `track-${Date.now()}`,
    name: "Новый трек",
    type: "video",
    clips: [],
    isLocked: false,
    isMuted: false,
    isHidden: false,
  });
};
```

### Добавление клипа на трек

```typescript
// В компоненте таймлайна
const { addClip, activeTrackId } = useTimeline();
const { selectedMedia } = useMedia();

const handleAddClip = () => {
  if (selectedMedia && activeTrackId) {
    addClip(activeTrackId, {
      id: `clip-${Date.now()}`,
      mediaId: selectedMedia.id,
      startTime: 0, // Начальное время на таймлайне
      duration: selectedMedia.duration,
      mediaStartTime: 0, // Начальное время в исходном файле
      mediaEndTime: selectedMedia.duration, // Конечное время в исходном файле
      effects: [],
      transitions: [],
    });
  }
};
```

## Горячие клавиши

- `Space` - воспроизведение/пауза
- `Delete` - удаление выбранного клипа
- `Ctrl+Z` - отмена действия
- `Ctrl+Shift+Z` - повтор действия
- `Ctrl+C` - копирование выбранного клипа
- `Ctrl+V` - вставка клипа
- `Ctrl+X` - вырезание выбранного клипа
- `Ctrl+S` - сохранение проекта
- `Ctrl+O` - открытие проекта
- `Ctrl+N` - создание нового проекта
- `Ctrl+E` - экспорт проекта

## Планы по развитию

- Исправление работы шкалы на таймлайне
- Корректная работа бара на таймлайне
- Перемещение дорожек по вертикали
- Реализация горячих клавиш
- Опции дорожек
- Выделение сегментов при записи
- Сведение дорожек в одну

## Связанные документы

- [Обзор архитектуры](../architecture/overview.md)
- [Машины состояний](../architecture/state-machines.md)
- [Руководство пользователя по таймлайну](../user-guide/timeline.md)
