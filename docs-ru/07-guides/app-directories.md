# Руководство по разработке Timeline Studio

## Обзор

Timeline Studio — это настольное приложение для видеомонтажа, построенное на Next.js, React и Tauri. Это руководство предоставляет важную информацию для разработчиков, работающих над проектом.

## Директории приложения

Timeline Studio автоматически создает и управляет структурой директорий для хранения пользовательских данных и ресурсов приложения. При первом запуске создаются следующие директории:

### Расположение базовой директории
- **macOS**: `~/Movies/Timeline Studio`
- **Windows**: `~/Videos/Timeline Studio`
- **Linux**: `~/Videos/Timeline Studio`

### Структура директорий
```
Timeline Studio/
├── Media/                  # Пользовательские медиафайлы и ресурсы
│   ├── Videos/            # Видеофайлы
│   ├── Images/            # Изображения
│   ├── Music/             # Аудио/музыкальные файлы
│   ├── Effects/           # Пользовательские видеоэффекты
│   ├── Transitions/       # Пользовательские переходы
│   ├── Filters/           # Пользовательские фильтры
│   ├── StyleTemplates/    # Шаблоны стилей
│   ├── Subtitles/         # Файлы субтитров
│   └── Templates/         # Шаблоны разметки
├── Projects/              # Сохраненные файлы проектов
├── Snapshot/              # Скриншоты и захваты кадров
├── Cinematic/             # Кинематографические пресеты и LUT
├── Output/                # Рендеренные/экспортированные видео
├── Render/                # Временные файлы рендера
├── Recognition/           # Данные ИИ-распознавания (YOLO и др.)
├── Backup/                # Резервные копии проектов
├── MediaProxy/            # Прокси-медиа для производительности
├── Caches/                # Кеши приложения
│   ├── Previews/          # Кеш превью видео
│   ├── Renders/           # Кеш рендера
│   ├── Frames/            # Кеш извлечения кадров
│   └── Temp/              # Временные файлы
├── Recorded/              # Записи экрана/камеры
├── Audio/                 # Аудиозаписи и обработка
├── Cloud Project/         # Проекты облачной синхронизации
├── Upload/                # Файлы, ожидающие загрузки
└── Chats/                 # Сессии и история ИИ-чата
```

### Автоматическое сканирование и загрузка ресурсов

При запуске приложения Timeline Studio автоматически сканирует следующие директории и загружает найденные файлы:

#### Сканируемые директории:
- **Media/Videos/** - Видеофайлы (.mp4, .avi, .mov, .mkv, .webm и др.)
- **Media/Images/** - Изображения (.jpg, .png, .gif, .svg, .webp и др.)
- **Media/Music/** - Музыкальные файлы (.mp3, .wav, .ogg, .m4a, .flac и др.)
- **Media/Effects/** - JSON файлы с описаниями эффектов
- **Media/Transitions/** - JSON файлы с описаниями переходов
- **Media/Filters/** - JSON файлы с описаниями фильтров
- **Media/StyleTemplates/** - JSON файлы стилистических шаблонов
- **Media/Subtitles/** - JSON файлы стилей субтитров

#### Особенности автозагрузки:
1. **Медиафайлы** (видео, изображения, музыка):
   - Определяются по расширению файла
   - Автоматически добавляются в соответствующие разделы браузера
   - Метаданные (размер, продолжительность) извлекаются позже

2. **JSON ресурсы** (эффекты, фильтры, переходы и т.д.):
   - Проходят валидацию перед загрузкой
   - Невалидные файлы игнорируются
   - Автоматически добавляются в систему управления ресурсами

#### Оптимизация производительности:
- **Кеширование результатов** - результаты сканирования кешируются на 15 минут
- **Пакетная обработка** - файлы обрабатываются пакетами по 10 штук
- **Параллельное сканирование** - все директории сканируются одновременно

#### Использование в коде:
```typescript
import { useAutoLoadUserData } from '@/features/media-studio/services';

// В компоненте React
function MyComponent() {
  const { isLoading, loadedData, error, reload } = useAutoLoadUserData();
  
  if (isLoading) return <div>Загрузка ресурсов...</div>;
  if (error) return <div>Ошибка: {error}</div>;
  
  console.log('Загруженные медиафайлы:', loadedData.media);
  console.log('Загруженные эффекты:', loadedData.effects);
}
```

### Доступ к директориям в коде

**Rust (Бэкенд):**
```rust
use timeline_studio::app_directories_service::AppDirectoriesService;

// Получить базовую директорию
let base_dir = AppDirectoriesService::get_base_directory().await?;

// Получить специфическую директорию
let projects_dir = AppDirectoriesService::get_projects_directory().await?;
```

**TypeScript (Фронтенд):**
```typescript
import { appDirectoriesService } from '@/features/app-state/services';

// Получить все директории
const directories = await appDirectoriesService.getAppDirectories();
console.log(directories.projects_dir);
console.log(directories.media_dir);
```

## Архитектура

### Обзор технологий
- **Фронтенд**: Next.js 15 (React 19) с TypeScript, статический экспорт для Tauri
- **Десктопная среда**: Tauri v2 (Rust) для нативных возможностей
- **Управление состоянием**: XState v5 для сложных машин состояний
- **UI компоненты**: shadcn/ui построенные на Radix UI примитивах
- **Стили**: Tailwind CSS v4 с CSS-переменными для тем

### Организация по функциям
Каждая функция в `/src/features/` самодостаточна и содержит:
- `components/` - React компоненты
- `hooks/` - Пользовательские React хуки
- `services/` - Бизнес-логика и машины состояний
- `types/` - TypeScript определения типов
- `utils/` - Вспомогательные функции
- `__tests__/` - Тестовые файлы для функции
- `__mocks__/` - Мок-реализации для тестирования

### Основные функции
- **timeline** - Основная временная шкала видеомонтажа с дорожками, клипами и секциями
- **media-studio** - Главный интерфейс редактирования с несколькими вариантами компоновки
- **video-player** - Пользовательский видеоплеер с точным покадровым управлением
- **browser** - Браузер медиафайлов с интерфейсом вкладок
- **effects/filters/transitions** - Система видеоэффектов с CSS-обработкой
- **templates** - Шаблоны мультикамерных разметок для редактирования с разделенным экраном
- **style-templates** - Анимированные шаблоны интро/аутро и заголовков
- **ai-chat** - Интегрированный ИИ-помощник (Claude/OpenAI)
- **recognition** - Распознавание сцен/объектов с использованием YOLO моделей

## Команды разработки

### Разработка
```bash
# Запуск сервера разработки Next.js с горячей перезагрузкой
bun run dev

# Запуск полного Tauri приложения в режиме разработки
bun run tauri dev
```

### Сборка
```bash
# Сборка фронтенда Next.js
bun run build

# Сборка продакшн Tauri приложения
bun run tauri build
```

### Тестирование
```bash
# Запуск всех тестов
bun run test

# Запуск тестов в режиме наблюдения
bun run test:watch

# Запуск конкретного тестового файла
bun run test src/features/timeline/__tests__/use-timeline.test.ts

# Генерация отчета о покрытии тестами
bun run test:coverage

# Запуск Rust тестов бэкенда
bun run test:rust

# Запуск end-to-end тестов Playwright
bun run test:e2e
```

### Качество кода
```bash
# Линтинг TypeScript/JavaScript файлов
bun run lint

# Автоисправление ошибок линтинга
bun run lint:fix

# Запуск всех проверок линтинга и тестов
bun run check:all

# Исправление всех автоисправляемых проблем
bun run fix:all
```

## Управление состоянием

Приложение использует машины состояний XState для сложного управления состоянием:

### Основные машины состояний
- **app-settings-machine** - Настройки и конфигурация приложения
- **browser-state-machine** - Состояние браузера медиа и выбор файлов
- **timeline-machine** - Состояние редактирования временной шкалы
- **player-machine** - Управление воспроизведением видео
- **chat-machine** - Интеграция ИИ-помощника
- **modal-machine** - Управление состоянием модальных окон
- **project-settings-machine** - Настройки, специфичные для проекта
- **resources-machine** - Управление ресурсами (эффекты, фильтры и т.д.)
- **user-settings-machine** - Пользовательские настройки и предпочтения

### Паттерны использования
Машины состояний создаются с использованием метода `setup` XState для лучшей типобезопасности:

```typescript
import { setup, assign } from 'xstate';

export const myMachine = setup({
  types: {
    context: {} as MyContext,
    events: {} as MyEvents,
  },
  actions: {
    updateData: assign({
      data: ({ event }) => event.data
    })
  }
}).createMachine({
  // определение машины
});
```

## Обработка медиа

### Интеграция FFmpeg
- Обработка видео осуществляется через интеграцию FFmpeg
- Медиафайлы ссылаются по пути, не встраиваются
- Файлы проектов используют пользовательскую схему для сохранения данных временной шкалы
- Восстановление отсутствующих файлов обрабатывается через MediaRestorationService

### Производительность
- Кешируйте превью агрессивно
- Используйте прокси-медиа для 4K+ контента
- Мониторьте размеры кешей
- Реализуйте LRU вытеснение
- Используйте потоковую передачу для больших файлов
- Очищайте временные файлы

## Отладка

### Отладка фронтенда
- Используйте React DevTools
- Включите XState Inspector
- Проверьте вкладку Network для API вызовов
- Используйте `console.log` с четкими префиксами

### Отладка Rust
- Используйте крейт `log` для логирования
- Проверьте вывод консоли Tauri
- Используйте `RUST_LOG=debug` для подробных логов
- Профилируйте с помощью `cargo flamegraph`

## Распространенные проблемы

### FFmpeg не найден
```bash
# Установка FFmpeg
brew install ffmpeg  # macOS
apt install ffmpeg   # Ubuntu/Debian
choco install ffmpeg # Windows
```

### Ошибки разрешений
- Проверьте разрешения файлов
- Убедитесь, что приложение имеет доступ к директориям
- Запускайте с соответствующими привилегиями

### Ошибки сборки
- Очистите кеши: `bun run clean`
- Пересоберите зависимости
- Проверьте версию Rust toolchain

## Интеграция ИИ-чата

Функция ИИ-чата предоставляет интегрированного ИИ-помощника для помощи в видеомонтаже.

### Текущая реализация
- Базовый UI чата в правой панели
- Машина состояний XState для управления состоянием
- Сервисные классы Claude и OpenAI (неполные)
- Всестороннее покрытие тестами для всех компонентов

### Хранилище
Чаты сохраняются в директориях приложения:
- **Расположение**: `~/Movies/Timeline Studio/Chats/` (macOS)
- **Формат**: JSON файлы с данными сессий чата
- **Автосохранение**: При каждом сообщении (когда реализовано)

### Поддерживаемые модели ИИ
- **Claude 4 Sonnet** - Быстрая и эффективная для повседневных задач
- **Claude 4 Opus** - Самая мощная для сложных задач
- **GPT-4** - Флагманская модель OpenAI
- **GPT-4o** - Улучшенная мультимодальная модель OpenAI
- **GPT-3.5 Turbo** - Быстрая и экономичная модель OpenAI
- **o3** - Новейшая модель рассуждений OpenAI

### Реализованные функции ✅
1. **Система хранения чатов**: Локальное файловое сохранение чатов
2. **Интеграция XState**: Полное управление состоянием
3. **Сервисный слой**: Сервисы API Claude и OpenAI
4. **React компоненты**: Полная реализация UI
5. **TypeScript типы**: Полная система типов
6. **Всестороннее тестирование**: 93% покрытие тестами

### Планируемые функции
1. **Множественные сессии чата**: Создание, переключение и управление множественными чатами
2. **Реальная интеграция ИИ**: Завершение API Claude и OpenAI
3. **Контекст временной шкалы**: Передача текущего состояния проекта ИИ
4. **Выполнение команд**: Выполнение операций временной шкалы из чата
5. **Потоковые ответы**: Потоковая передача ответов в реальном времени

### API ключи
API ключи должны храниться безопасно:
```typescript
// Используйте безопасное хранилище API Tauri
import { Store } from '@tauri-apps/plugin-store';

const store = new Store('.settings');
await store.set('claude_api_key', 'sk-...');
await store.save();
```

## Вклад в разработку

1. Создайте ветку функции
2. Напишите тесты для новых функций
3. Убедитесь, что все тесты проходят
4. Обновите документацию
5. Отправьте pull request

## Ресурсы

- [Документация Tauri](https://tauri.app/v1/guides/)
- [Документация XState](https://xstate.js.org/docs/)
- [Документация Next.js](https://nextjs.org/docs)
- [Документация FFmpeg](https://ffmpeg.org/documentation.html)
- [Документация API Claude](https://docs.anthropic.com/claude/reference/getting-started-with-the-api)
- [Документация API OpenAI](https://platform.openai.com/docs/introduction)