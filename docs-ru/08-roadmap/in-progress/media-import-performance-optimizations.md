# Оптимизация производительности импорта медиа

## Выявленные проблемы

При загрузке папок с большим количеством видео приложение испытывало значительные задержки из-за:

1. **Избыточные перерендеры** - Каждое обновление метаданных вызывало отдельное обновление состояния
2. **Синхронная обработка** - Вызовы к бэкенду выполнялись последовательно
3. **Отсутствие группировки** - Обновления UI происходили для каждого файла
4. **Тяжелые вызовы FFprobe** - Каждый файл вызывал отдельный процесс FFprobe

## Реализованные оптимизации

### 1. Групповые обновления с дебаунсингом

Вместо обновления состояния для каждого файла, теперь мы группируем обновления:

```typescript
// Группируем ожидающие обновления
const pendingUpdates: MediaFile[] = []
let updateTimer: NodeJS.Timeout | null = null

// Ставим обновление в очередь вместо немедленного изменения состояния
const queueUpdate = (file: MediaFile) => {
  pendingUpdates.push(file)
  
  // Динамическая задержка на основе размера пакета
  const delay = pendingUpdates.length > 10 ? 100 : 50
  updateTimer = setTimeout(() => {
    requestAnimationFrame(batchUpdate)
  }, delay)
}
```

### 2. Увеличена параллельная обработка

- Увеличен `MAX_CONCURRENT_REQUESTS` с 3 до 5
- Уменьшен `REQUEST_DELAY` с 50мс до 20мс
- Это позволяет быстрее обрабатывать метаданные параллельно

### 3. Прогрессивная загрузка для больших папок

Для папок с >100 файлами:
- Первые 50 файлов обрабатываются сразу
- Остальные файлы обрабатываются после задержки в 100мс
- Это обеспечивает отзывчивость UI

```typescript
if (mediaFiles.length > 100) {
  const firstBatch = mediaFiles.slice(0, 50)
  const remainingFiles = mediaFiles.slice(50)
  
  // Обрабатываем первый пакет сразу
  const firstBatchProcessed = await processFiles(firstBatch)
  
  // Обрабатываем остальные с задержкой
  setTimeout(async () => {
    const remainingProcessed = await processFiles(remainingFiles)
    await saveFilesToProject([...firstBatchProcessed, ...remainingProcessed])
  }, 100)
}
```

### 4. Существующие оптимизации сохранены

- **Виртуализация** - Отрисовываются только видимые элементы
- **Мемоизация** - Компоненты избегают ненужных перерендеров
- **Потоковое видео** - Видео не загружаются в память
- **Предзагрузка метаданных** - Загружаются только метаданные, не полное видео

## Улучшения производительности

1. **Время начальной загрузки**: Быстрее для больших папок благодаря прогрессивной загрузке
2. **Отзывчивость UI**: Остается интерактивным во время загрузки метаданных
3. **Использование памяти**: Снижено благодаря группировке
4. **Использование CPU**: Более эффективно с параллельной обработкой

## Рекомендации по тестированию

1. Тестировать с папками, содержащими 500+ видео
2. Мониторить использование CPU во время импорта
3. Проверять отзывчивость UI во время загрузки
4. Убедиться, что все файлы в итоге загружаются с метаданными

## Будущие улучшения

1. **Кэширование метаданных** - Кэшировать результаты FFprobe для файлов
2. **Воркер-потоки** - Перенести обработку метаданных в веб-воркеры
3. **Группировка на стороне Rust** - Группировать вызовы FFprobe на бэкенде
4. **Частичная загрузка** - Загружать метаданные только для видимых элементов