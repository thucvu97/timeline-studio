# AI Chat - Функция чата с ИИ

## Обзор

Функция AI Chat предоставляет интегрированного ИИ-помощника в Timeline Studio для помощи пользователям в задачах видеомонтажа, предоставления предложений и выполнения команд. Чат интегрирован в правую панель и поддерживает множество AI моделей для различных задач.

## Текущий статус

### ✅ Реализовано
- **Современный UI чата**: 
  - Новый дизайн с заголовком и кнопками управления
  - Поле ввода размещается вверху при отсутствии сообщений
  - Динамическая кнопка отправки с изменением стиля
  - Интеграция с дизайн-системой проекта (использование theme colors)
- **Режимы работы чата**:
  - Chat - обычный диалог
  - Gather - чтение файлов без редактирования
  - Agent - полный доступ к инструментам и редактированию
- **История чатов**:
  - Отображение списка предыдущих сессий
  - Hover эффекты с кнопками копирования и удаления
  - Показ количества сообщений и времени последнего обновления
- **Управление состоянием**: XState машина для состояния чата
- **Context Provider**: React контекст для доступа к чату
- **Архитектура сервисов**: Классы сервисов Claude и OpenAI
- **Управление сообщениями**: Добавление/удаление сообщений, очистка истории
- **Сохранение чатов**: LocalChatStorageService для персистентности
- **Интеграция в UI**: Встроен в правую панель с возможностью изменения размера

### ⚠️ Частично реализовано
- **AI сервисы**: Классы сервисов существуют, но интеграция API неполная
- **Выбор модели**: UI с dropdown меню для выбора моделей, но не подключен к реальным API
- **Обработка ошибок**: State машина обрабатывает ошибки, но нет обработки ошибок API
- **Управление API ключами**: Интегрировано с UserSettings, но требует доработки

### ❌ Не реализовано
- **Создание новых чатов**: При нажатии "+" должен появляться новый элемент со спиннером (см. [ТЗ создания чатов](../../../docs-ru/08-roadmap/in-progress/chat-new-creation-spec.md))
- **Переключение между чатами**: Нет возможности загрузить предыдущий чат
- **Копирование чатов**: Кнопка копирования есть, но не работает
- **Автосохранение**: Сообщения не сохраняются автоматически
- **Реальная интеграция ИИ**: Сейчас возвращаются моковые ответы
- **Контекст Timeline**: Чат не знает о текущем состоянии проекта
- **Выполнение команд**: Невозможно выполнять действия на основе ответов ИИ
- **Потоковые ответы**: Нет потоковой передачи ответов в реальном времени
- **Рендеринг Markdown**: Сообщения только в виде простого текста
- **Интеграция с видеоредактором**: Нет связи с функциями редактирования

## UI дизайн

### Общий вид
- **Заголовок**: "CHAT" с кнопками управления справа
- **Кнопки управления**: 
  - Plus (+) - создание нового чата
  - History - показ/скрытие истории
  - Settings - открытие настроек
  - X - закрытие панели чата
- **Цветовая схема**: Использует системные цвета темы (background, foreground, muted, teal)

### Поле ввода
- **Расположение**: Вверху при отсутствии сообщений, внизу при наличии
- **Placeholder**: "@ to mention, ⌘L to add a selection. Enter instructions..."
- **Кнопка отправки**: Меняет стиль в зависимости от наличия текста
  - Неактивная: серая стрелка на темном фоне
  - Активная: белая стрелка на бирюзовом фоне (teal)

### Селекторы
- **Режим чата**: Dropdown с вариантами Chat/Gather/Agent
- **Модель AI**: Dropdown со списком доступных моделей

### История чатов
- **Список предыдущих чатов**: Показывает название, время и количество сообщений
- **Hover эффекты**: При наведении появляются кнопки:
  - Copy - копирование чата
  - Trash - удаление чата
- **Создание нового чата**: При нажатии "+" в списке появляется временный элемент:
  - Спиннер (Loader2) в начале строки с анимацией вращения
  - Текст placeholder: "составь план рефакторинга" 
  - Индикатор времени: "1 Today"
  - После создания спиннер исчезает и чат становится активным

### Сообщения
- **Сообщения пользователя**: Бирюзовый фон (bg-teal), выравнивание справа
- **Сообщения AI**: Серый фон (bg-muted), выравнивание слева
- **Иконки**: User для пользователя, Bot для AI
- **Время**: Показывается при наведении на сообщение

## Архитектура

### Структура компонентов
```
ai-chat/
├── components/
│   ├── ai-chat.tsx          # Основной компонент UI чата
│   ├── claude-service.ts    # Сервис Claude API (неполный)
│   └── open-ai-service.ts   # Сервис OpenAI API (неполный)
├── hooks/
│   ├── use-chat.tsx         # Основной хук для полного контекста
│   ├── use-chat-actions.tsx # Хук только для действий
│   └── use-chat-state.ts    # Хук только для состояния
├── services/
│   ├── chat-machine.ts      # XState state машина
│   ├── chat-provider.tsx    # React context provider
│   └── chat-storage-service.ts # Сервис хранения чатов (новый)
├── types/
│   └── chat.ts             # TypeScript типы (новый)
└── __tests__/              # Тестовые файлы
```

### Состояния State Machine
- `idle` - Начальное состояние, ожидание ввода
- `processing` - Отправка сообщения ИИ
- `error` - Произошла ошибка при обработке

### События
- `SEND_CHAT_MESSAGE` - Отправить новое сообщение
- `RECEIVE_CHAT_MESSAGE` - Получить ответ ИИ
- `REMOVE_MESSAGE` - Удалить конкретное сообщение
- `CLEAR_MESSAGES` - Очистить все сообщения
- `SELECT_AGENT` - Изменить модель/провайдера ИИ
- `SET_PROCESSING` - Установить состояние обработки
- `SET_ERROR` - Обработать ошибки

## Новые добавленные компоненты

### ChatStorageService
Сервис для управления сохранением и загрузкой чатов:
- Сохраняет чаты в `~/Movies/Timeline Studio/Chats/` (macOS)
- Автоматически создает директорию при первом использовании
- Поддерживает создание, чтение, обновление и удаление чатов
- Поиск по истории чатов
- Экспорт/импорт чатов в JSON

### Типы данных
- `ChatSession` - Полная сессия чата с сообщениями
- `ChatMessage` - Отдельное сообщение в чате
- `ChatListItem` - Элемент списка для отображения в UI
- `TimelineContext` - Контекст текущего проекта для ИИ
- `Agent` - Доступные модели ИИ

### Поддерживаемые модели ИИ
- **Claude 4 Sonnet** - Быстрая и эффективная модель для повседневных задач
- **Claude 4 Opus** - Самая мощная модель для сложных задач
- **GPT-4** - Флагманская модель OpenAI
- **GPT-4o** - Улучшенная мультимодальная модель OpenAI
- **GPT-3.5 Turbo** - Быстрая и экономичная модель OpenAI
- **o3** - Новейшая модель рассуждений OpenAI
- **DeepSeek** - Открытая модель с поддержкой длинного контекста (планируется)

## План реализации MVP

### Фаза 1: Управление чатами (Приоритет: Высокий) ✅
1. ✅ Добавить модель/типы сессий чата
2. ✅ Реализовать сервис хранения чатов
3. ⏳ Создать компонент списка чатов
4. ⏳ Добавить функционал создания/удаления чатов
5. ⏳ Реализовать логику переключения чатов

### Фаза 2: Сохранение (Приоритет: Высокий) ✅
1. ✅ Интеграция с AppDirectoriesService
2. ✅ Создать хранилище чатов в `~/Movies/Timeline Studio/Chats/`
3. ⏳ Реализовать автосохранение
4. ⏳ Добавить загрузку чатов при запуске

### Фаза 3: Интеграция ИИ (Приоритет: Высокий)
1. ⏳ Завершить интеграцию API в сервисах
2. ⏳ Добавить UI управления API ключами
3. ⏳ Реализовать потоковые ответы
4. ⏳ Добавить правильную обработку ошибок

### Фаза 4: Интеграция Timeline (Приоритет: Средний)
1. ⏳ Создать сериализатор контекста timeline
2. ⏳ Добавить контекст в промпты ИИ
3. ⏳ Парсить ответы ИИ для команд
4. ⏳ Реализовать выполнение команд

### Фаза 5: Улучшения UI (Приоритет: Низкий)
1. ⏳ Добавить рендеринг markdown
2. ⏳ Реализовать лучшее форматирование сообщений
3. ⏳ Добавить полировку UI и анимации

## Что нужно сделать дальше

### 1. Создать компонент списка чатов
```tsx
// components/chat-list.tsx
- Отображение списка всех чатов
- Поиск по чатам
- Создание нового чата с анимированным спиннером
- Удаление чата (hover эффект с иконкой Trash2)
- Копирование чата (hover эффект с иконкой Copy)
- Переключение между чатами
- Временный элемент при создании:
  - Loader2 с классом animate-spin
  - Placeholder текст
  - Индикатор времени
```

### 2. Обновить chat-machine для поддержки сессий
```typescript
// Добавить в контекст:
- currentSessionId: string | null
- sessions: ChatListItem[]

// Добавить события:
- CREATE_SESSION
- LOAD_SESSION
- DELETE_SESSION
- SWITCH_SESSION
```

### 3. Интегрировать chatStorageService в провайдер
```typescript
// В ChatProvider:
- Загружать список сессий при инициализации
- Автосохранять при добавлении сообщений
- Синхронизировать состояние с хранилищем
```

### 4. Завершить интеграцию API
```typescript
// В claude-service.ts и open-ai-service.ts:
- Реальные вызовы API
- Обработка потоковых ответов
- Управление API ключами
- Обработка ошибок и повторные попытки
```

## Руководство по тестированию

### Модульные тесты
- [x] Тесты переходов состояний chat machine
- [x] Тесты логики управления сообщениями
- [x] Тесты методов API сервисов (Claude и OpenAI)
- [x] Тесты слоя сохранения (LocalChatStorageService)
- [x] Тесты компонентов UI (AiChat)
- [x] Тесты всех хуков (useChat, useChatActions, useChatState)
- [x] Тесты провайдера контекста (ChatProvider)

### Интеграционные тесты
- [x] Тест потока создания/удаления чата
- [x] Тест потока отправки/получения сообщений
- [ ] Тест выполнения команд timeline
- [x] Тест восстановления после ошибок

### E2E тесты
- [ ] Тест полного рабочего процесса чата
- [ ] Тест сохранения между перезапусками приложения
- [ ] Тест интеграции с реальными сервисами

### Запуск тестов
```bash
# Все тесты AI Chat
bun run test src/features/ai-chat

# Конкретная категория
bun run test src/features/ai-chat/__tests__/hooks
bun run test src/features/ai-chat/__tests__/services
bun run test src/features/ai-chat/__tests__/components

# В режиме наблюдения
bun run test:watch src/features/ai-chat

# С покрытием
bun run test:coverage src/features/ai-chat
```

### Текущее покрытие тестами
```
Статистика тестов:
- Файлов тестов: 10
- Всего тестов: 143
- Прошедших: 133
- Пропущенных: 10 (сложные интеграционные тесты)

Особенности тестирования:
- Все иконки lucide-react используют глобальные моки из src/test/mocks/libraries/
- data-testid для иконок в lowercase формате (например: "stopcircle-icon")
- Компоненты UI (dropdown, scroll-area) также замокированы глобально
- Тесты адаптированы под новый UI дизайн и цветовую схему
```

### Структура тестов
```
ai-chat/__tests__/
├── components/
│   ├── ai-chat.test.tsx         # Тесты UI компонента (обновлены под новый дизайн)
│   └── ai-chat-simple.test.tsx  # Упрощенные тесты базовой функциональности
├── hooks/
│   ├── use-chat.test.tsx        # Тесты основного хука
│   ├── use-chat-actions.test.tsx # Тесты хука действий
│   └── use-chat-state.test.tsx  # Тесты хука состояния
└── services/
    ├── chat-machine.test.ts     # Тесты XState машины
    ├── chat-provider.test.tsx   # Тесты провайдера
    ├── chat-storage-service.test.ts # Тесты хранилища
    ├── claude-service.test.ts   # Тесты Claude API
    └── open-ai-service.test.ts  # Тесты OpenAI API

Глобальные моки (src/test/mocks/libraries/lucide-react.ts):
- Все иконки Lucide React (Bot, User, Send, Plus, Settings, etc.)
- Формат data-testid: {iconname.toLowerCase()}-icon
- Автоматически импортируются через setup.ts
```

## Соображения по производительности

- Ограничить историю чата до последних 100 сообщений в памяти
- Реализовать виртуальную прокрутку для длинных разговоров
- Кэшировать ответы ИИ для идентичных запросов
- Добавить debounce для отправки сообщений
- Реализовать отмену запросов

## Соображения по безопасности

- Хранить API ключи в защищенном системном хранилище
- Никогда не логировать API ключи или полные промпты
- Санитизировать пользовательский ввод перед отправкой ИИ
- Реализовать ограничение скорости запросов
- Добавить фильтрацию контента для неподходящего содержимого

## Будущие улучшения

### Интеграция с видеоредактором (см. docs-ru/08-roadmap/in-progress/ai-models-integration.md)
- **Работа с субтитрами**: Автоматическая генерация, перевод, стилизация
- **Автоматизация монтажа**: Умная нарезка, удаление пауз, цветокоррекция
- **Создание контента**: Генерация превью, описаний, тегов
- **Контекстные команды**: Выполнение действий на таймлайне через чат

### Расширенные возможности чата
- **Голосовой ввод/вывод**: Диктовка команд и озвучка ответов
- **Многоязычная поддержка**: Работа на 10 языках интерфейса
- **Визуальные подсказки**: Превью результатов перед применением
- **История действий**: Отмена команд выполненных через AI

### Технические улучшения
- **Локальные модели**: Поддержка Ollama для работы без интернета
- **Кастомная донастройка**: Fine-tuning моделей для видеомонтажа
- **Плагины и расширения**: API для сторонних интеграций
- **Пакетная обработка**: Применение команд к множеству клипов

### Социальные функции
- **Совместные сессии**: Работа над проектом с командой
- **Обмен промптами**: Библиотека полезных команд
- **AI-ассистированное обучение**: Интерактивные туториалы