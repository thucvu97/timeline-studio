# AI Chat - Функция чата с ИИ

## Обзор

Функция AI Chat предоставляет интегрированного ИИ-помощника в Timeline Studio для помощи пользователям в задачах видеомонтажа, предоставления предложений и выполнения команд.

## Текущий статус

### ✅ Реализовано
- **Базовый UI чата**: Отображение сообщений, поле ввода, функция отправки
- **Управление состоянием**: XState машина для состояния чата
- **Context Provider**: React контекст для доступа к чату
- **Архитектура сервисов**: Классы сервисов Claude и OpenAI
- **Управление сообщениями**: Добавление/удаление сообщений, очистка истории
- **Интеграция в UI**: Встроен в правую панель Timeline

### ⚠️ Частично реализовано
- **AI сервисы**: Классы сервисов существуют, но интеграция API неполная
- **Выбор модели**: UI существует, но не подключен к реальным API
- **Обработка ошибок**: State машина обрабатывает ошибки, но нет обработки ошибок API

### ❌ Не реализовано
- **Множественные чаты**: Нет возможности создавать новые чаты или переключаться между ними
- **Сохранение чатов**: Сообщения теряются при перезагрузке
- **Список/История чатов**: Нет UI для просмотра предыдущих разговоров
- **Реальная интеграция ИИ**: Сейчас возвращаются моковые ответы
- **Контекст Timeline**: Чат не знает о текущем состоянии проекта
- **Выполнение команд**: Невозможно выполнять действия на основе ответов ИИ
- **Потоковые ответы**: Нет потоковой передачи ответов в реальном времени
- **Рендеринг Markdown**: Сообщения только в виде простого текста

## Архитектура

### Структура компонентов
```
ai-chat/
├── components/
│   ├── ai-chat.tsx          # Основной компонент UI чата
│   ├── claude-service.ts    # Сервис Claude API (неполный)
│   └── open-ai-service.ts   # Сервис OpenAI API (неполный)
├── hooks/
│   ├── use-chat.tsx         # Основной хук для полного контекста
│   ├── use-chat-actions.tsx # Хук только для действий
│   └── use-chat-state.ts    # Хук только для состояния
├── services/
│   ├── chat-machine.ts      # XState state машина
│   ├── chat-provider.tsx    # React context provider
│   └── chat-storage-service.ts # Сервис хранения чатов (новый)
├── types/
│   └── chat.ts             # TypeScript типы (новый)
└── __tests__/              # Тестовые файлы
```

### Состояния State Machine
- `idle` - Начальное состояние, ожидание ввода
- `processing` - Отправка сообщения ИИ
- `error` - Произошла ошибка при обработке

### События
- `SEND_MESSAGE` - Отправить новое сообщение
- `RECEIVE_RESPONSE` - Получить ответ ИИ
- `REMOVE_MESSAGE` - Удалить конкретное сообщение
- `CLEAR_MESSAGES` - Очистить все сообщения
- `SET_AGENT` - Изменить модель/провайдера ИИ
- `ERROR` - Обработать ошибки

## Новые добавленные компоненты

### ChatStorageService
Сервис для управления сохранением и загрузкой чатов:
- Сохраняет чаты в `~/Movies/Timeline Studio/Chats/` (macOS)
- Автоматически создает директорию при первом использовании
- Поддерживает создание, чтение, обновление и удаление чатов
- Поиск по истории чатов
- Экспорт/импорт чатов в JSON

### Типы данных
- `ChatSession` - Полная сессия чата с сообщениями
- `ChatMessage` - Отдельное сообщение в чате
- `ChatListItem` - Элемент списка для отображения в UI
- `TimelineContext` - Контекст текущего проекта для ИИ
- `Agent` - Доступные модели ИИ

### Поддерживаемые модели ИИ
- **Claude 4 Sonnet** - Быстрая и эффективная модель для повседневных задач
- **Claude 4 Opus** - Самая мощная модель для сложных задач
- **GPT-4** - Флагманская модель OpenAI
- **GPT-4o** - Улучшенная мультимодальная модель OpenAI
- **GPT-3.5 Turbo** - Быстрая и экономичная модель OpenAI
- **o3** - Новейшая модель рассуждений OpenAI

## План реализации MVP

### Фаза 1: Управление чатами (Приоритет: Высокий) ✅
1. ✅ Добавить модель/типы сессий чата
2. ✅ Реализовать сервис хранения чатов
3. ⏳ Создать компонент списка чатов
4. ⏳ Добавить функционал создания/удаления чатов
5. ⏳ Реализовать логику переключения чатов

### Фаза 2: Сохранение (Приоритет: Высокий) ✅
1. ✅ Интеграция с AppDirectoriesService
2. ✅ Создать хранилище чатов в `~/Movies/Timeline Studio/Chats/`
3. ⏳ Реализовать автосохранение
4. ⏳ Добавить загрузку чатов при запуске

### Фаза 3: Интеграция ИИ (Приоритет: Высокий)
1. ⏳ Завершить интеграцию API в сервисах
2. ⏳ Добавить UI управления API ключами
3. ⏳ Реализовать потоковые ответы
4. ⏳ Добавить правильную обработку ошибок

### Фаза 4: Интеграция Timeline (Приоритет: Средний)
1. ⏳ Создать сериализатор контекста timeline
2. ⏳ Добавить контекст в промпты ИИ
3. ⏳ Парсить ответы ИИ для команд
4. ⏳ Реализовать выполнение команд

### Фаза 5: Улучшения UI (Приоритет: Низкий)
1. ⏳ Добавить рендеринг markdown
2. ⏳ Реализовать лучшее форматирование сообщений
3. ⏳ Добавить полировку UI и анимации

## Что нужно сделать дальше

### 1. Создать компонент списка чатов
```tsx
// components/chat-list.tsx
- Отображение списка всех чатов
- Поиск по чатам
- Создание нового чата
- Удаление чата
- Переключение между чатами
```

### 2. Обновить chat-machine для поддержки сессий
```typescript
// Добавить в контекст:
- currentSessionId: string | null
- sessions: ChatListItem[]

// Добавить события:
- CREATE_SESSION
- LOAD_SESSION
- DELETE_SESSION
- SWITCH_SESSION
```

### 3. Интегрировать chatStorageService в провайдер
```typescript
// В ChatProvider:
- Загружать список сессий при инициализации
- Автосохранять при добавлении сообщений
- Синхронизировать состояние с хранилищем
```

### 4. Завершить интеграцию API
```typescript
// В claude-service.ts и open-ai-service.ts:
- Реальные вызовы API
- Обработка потоковых ответов
- Управление API ключами
- Обработка ошибок и повторные попытки
```

## Руководство по тестированию

### Модульные тесты
- [x] Тесты переходов состояний chat machine
- [x] Тесты логики управления сообщениями
- [x] Тесты методов API сервисов (Claude и OpenAI)
- [x] Тесты слоя сохранения (LocalChatStorageService)
- [x] Тесты компонентов UI (AiChat)
- [x] Тесты всех хуков (useChat, useChatActions, useChatState)
- [x] Тесты провайдера контекста (ChatProvider)

### Интеграционные тесты
- [x] Тест потока создания/удаления чата
- [x] Тест потока отправки/получения сообщений
- [ ] Тест выполнения команд timeline
- [x] Тест восстановления после ошибок

### E2E тесты
- [ ] Тест полного рабочего процесса чата
- [ ] Тест сохранения между перезапусками приложения
- [ ] Тест интеграции с реальными сервисами

### Запуск тестов
```bash
# Все тесты AI Chat
bun run test src/features/ai-chat

# Конкретная категория
bun run test src/features/ai-chat/__tests__/hooks
bun run test src/features/ai-chat/__tests__/services
bun run test src/features/ai-chat/__tests__/components

# В режиме наблюдения
bun run test:watch src/features/ai-chat

# С покрытием
bun run test:coverage src/features/ai-chat
```

### Текущее покрытие тестами
```
Статистика тестов:
- Файлов тестов: 10
- Всего тестов: 143
- Прошедших: 133
- Пропущенных: 10 (сложные интеграционные тесты)

Покрытие кода:
- Statements: 78.04% (компоненты), 84.06% (сервисы), 80.95% (хуки)
- Branches: 87.34% (компоненты), 78.94% (сервисы), 100% (хуки)
- Functions: 88.88% (компоненты), 83.33% (сервисы), 75% (хуки)
- Lines: 78.04% (компоненты), 84.06% (сервисы), 80.95% (хуки)
```

### Структура тестов
```
ai-chat/__tests__/
├── components/
│   └── ai-chat.test.tsx         # Тесты UI компонента
├── hooks/
│   ├── use-chat.test.tsx        # Тесты основного хука
│   ├── use-chat-actions.test.tsx # Тесты хука действий
│   └── use-chat-state.test.tsx  # Тесты хука состояния
└── services/
    ├── chat-machine.test.ts     # Тесты XState машины
    ├── chat-provider.test.tsx   # Тесты провайдера
    ├── chat-storage-service.test.ts # Тесты хранилища
    ├── claude-service.test.ts   # Тесты Claude API
    └── open-ai-service.test.ts  # Тесты OpenAI API
```

## Соображения по производительности

- Ограничить историю чата до последних 100 сообщений в памяти
- Реализовать виртуальную прокрутку для длинных разговоров
- Кэшировать ответы ИИ для идентичных запросов
- Добавить debounce для отправки сообщений
- Реализовать отмену запросов

## Соображения по безопасности

- Хранить API ключи в защищенном системном хранилище
- Никогда не логировать API ключи или полные промпты
- Санитизировать пользовательский ввод перед отправкой ИИ
- Реализовать ограничение скорости запросов
- Добавить фильтрацию контента для неподходящего содержимого

## Будущие улучшения

- Голосовой ввод/вывод
- Многоязычная поддержка
- Кастомная донастройка ИИ для видеомонтажа
- Совместные сессии чата
- ИИ-анализ видео
- Автоматическая генерация субтитров
- Умные предложения клипов на основе контента