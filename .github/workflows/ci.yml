name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: bun install
        
      - name: Run linting
        run: bun run lint
        
      - name: Run tests
        run: bun run test
        
      - name: Build frontend
        run: bun run build

  test-backend:
    name: Test Backend
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
            
      # Linux dependencies
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ffmpeg \
            libavcodec-dev \
            libavformat-dev \
            libavutil-dev \
            libavfilter-dev \
            libavdevice-dev \
            libswscale-dev \
            libswresample-dev \
            pkg-config \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libglib2.0-dev \
            libcairo2-dev \
            libpango1.0-dev \
            libgdk-pixbuf2.0-dev
            
      - name: Verify FFmpeg installation
        if: runner.os == 'Linux'
        run: |
          echo "Verifying FFmpeg installation..."
          pkg-config --version
          echo "Looking for libavutil.pc..."
          find /usr -name "libavutil.pc" 2>/dev/null || echo "libavutil.pc not found"
          echo "Testing pkg-config with libavutil..."
          PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig pkg-config --libs --cflags libavutil || echo "pkg-config failed"
            
      # macOS dependencies  
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew install ffmpeg onnxruntime
          
      # Windows dependencies - optimized approach
      - name: Setup Windows dependencies
        if: runner.os == 'Windows'
        shell: powershell
        timeout-minutes: 15
        run: |
          # Install chocolatey packages
          choco install pkgconfiglite -y --no-progress
          
          # Download and setup prebuilt FFmpeg (much faster than vcpkg)
          try {
            $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl-shared.zip"
            Write-Host "Downloading FFmpeg from GitHub releases..."
            Invoke-WebRequest -Uri $ffmpegUrl -OutFile "ffmpeg.zip" -TimeoutSec 300
            Expand-Archive -Path "ffmpeg.zip" -DestinationPath "C:\" -Force
            $ffmpegExtracted = Get-ChildItem "C:\ffmpeg-*" | Select-Object -First 1
            if ($ffmpegExtracted) {
              Rename-Item $ffmpegExtracted.FullName "C:\ffmpeg" -Force
              Write-Host "✅ FFmpeg setup successful via GitHub releases"
            }
          }
          catch {
            Write-Host "GitHub method failed, trying Gyan.dev..."
            $ffmpegUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full-shared.7z"
            Invoke-WebRequest -Uri $ffmpegUrl -OutFile "ffmpeg.7z" -TimeoutSec 600
            7z x ffmpeg.7z -o"C:\" -y
            $ffmpegDir = Get-ChildItem "C:\ffmpeg-*" | Select-Object -First 1
            if ($ffmpegDir) {
              Rename-Item $ffmpegDir.FullName "C:\ffmpeg" -Force
              Write-Host "✅ FFmpeg setup successful via Gyan.dev"
            }
          }
          
          # Set up comprehensive environment for FFmpeg development
          echo "FFMPEG_DIR=C:\ffmpeg" >> $env:GITHUB_ENV
          echo "PKG_CONFIG_PATH=C:\ffmpeg\lib\pkgconfig" >> $env:GITHUB_ENV
          echo "C:\ffmpeg\bin" >> $env:GITHUB_PATH
          
          # Configure for ffmpeg-sys-next crate
          echo "FFMPEG_INCLUDE_DIR=C:\ffmpeg\include" >> $env:GITHUB_ENV
          echo "FFMPEG_LIB_DIR=C:\ffmpeg\lib" >> $env:GITHUB_ENV
          echo "FFMPEG_LINK_TYPE=dynamic" >> $env:GITHUB_ENV
          echo "FFMPEG_NO_PKG_CONFIG=1" >> $env:GITHUB_ENV
          echo "BINDGEN_EXTRA_CLANG_ARGS=-IC:/ffmpeg/include" >> $env:GITHUB_ENV
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "FFMPEG_PKG_CONFIG_PATH=C:\ffmpeg\lib\pkgconfig" >> $env:GITHUB_ENV
          
          # Verify critical components
          if (Test-Path "C:\ffmpeg\bin\ffmpeg.exe") {
            Write-Host "✅ FFmpeg executable found"
            if (Test-Path "C:\ffmpeg\include\libavcodec\avcodec.h") {
              Write-Host "✅ FFmpeg development headers found"
            } else {
              Write-Host "❌ FFmpeg headers missing - build may fail"
            }
          } else {
            Write-Host "❌ FFmpeg not found - build will fail"
            exit 1
          }
          
      - name: Run backend tests
        working-directory: src-tauri
        env:
          PKG_CONFIG_PATH: /usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig
          PKG_CONFIG_ALLOW_SYSTEM_LIBS: 1
          PKG_CONFIG_ALLOW_SYSTEM_CFLAGS: 1
        run: |
          cargo test --lib -- --test-threads=1
          
      - name: Run clippy
        working-directory: src-tauri
        env:
          PKG_CONFIG_PATH: /usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig
          PKG_CONFIG_ALLOW_SYSTEM_LIBS: 1
          PKG_CONFIG_ALLOW_SYSTEM_CFLAGS: 1
        run: cargo clippy --all-targets --all-features -- -D warnings
        
      - name: Check formatting
        working-directory: src-tauri
        run: cargo fmt -- --check

  build:
    name: Build Application
    needs: [test-frontend, test-backend]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
            node_modules
          key: ${{ runner.os }}-build-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/bun.lockb') }}
          
      # Repeat dependency installation steps from test job
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libavcodec-dev libavformat-dev libavutil-dev libavfilter-dev libavdevice-dev libswscale-dev libswresample-dev pkg-config libgtk-3-dev libwebkit2gtk-4.1-dev build-essential curl wget file libssl-dev libayatana-appindicator3-dev librsvg2-dev libglib2.0-dev libcairo2-dev libpango1.0-dev libgdk-pixbuf2.0-dev
          
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: brew install ffmpeg onnxruntime
        
      - name: Setup Windows dependencies
        if: runner.os == 'Windows'
        shell: powershell
        timeout-minutes: 15
        run: |
          choco install pkgconfiglite -y --no-progress
          
          try {
            $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl-shared.zip"
            Invoke-WebRequest -Uri $ffmpegUrl -OutFile "ffmpeg.zip" -TimeoutSec 300
            Expand-Archive -Path "ffmpeg.zip" -DestinationPath "C:\" -Force
            $ffmpegExtracted = Get-ChildItem "C:\ffmpeg-*" | Select-Object -First 1
            if ($ffmpegExtracted) {
              Rename-Item $ffmpegExtracted.FullName "C:\ffmpeg" -Force
            }
          }
          catch {
            $ffmpegUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full-shared.7z"
            Invoke-WebRequest -Uri $ffmpegUrl -OutFile "ffmpeg.7z" -TimeoutSec 600
            7z x ffmpeg.7z -o"C:\" -y
            $ffmpegDir = Get-ChildItem "C:\ffmpeg-*" | Select-Object -First 1
            if ($ffmpegDir) {
              Rename-Item $ffmpegDir.FullName "C:\ffmpeg" -Force
            }
          }
          
          echo "FFMPEG_DIR=C:\ffmpeg" >> $env:GITHUB_ENV
          echo "PKG_CONFIG_PATH=C:\ffmpeg\lib\pkgconfig" >> $env:GITHUB_ENV
          echo "C:\ffmpeg\bin" >> $env:GITHUB_PATH
          echo "FFMPEG_INCLUDE_DIR=C:\ffmpeg\include" >> $env:GITHUB_ENV
          echo "FFMPEG_LIB_DIR=C:\ffmpeg\lib" >> $env:GITHUB_ENV
          echo "FFMPEG_LINK_TYPE=dynamic" >> $env:GITHUB_ENV
          echo "FFMPEG_NO_PKG_CONFIG=1" >> $env:GITHUB_ENV
          echo "BINDGEN_EXTRA_CLANG_ARGS=-IC:/ffmpeg/include" >> $env:GITHUB_ENV
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "FFMPEG_PKG_CONFIG_PATH=C:\ffmpeg\lib\pkgconfig" >> $env:GITHUB_ENV
          
      - name: Install frontend dependencies
        run: bun install
        
      - name: Build frontend
        run: bun run build
        
      - name: Build Tauri application
        working-directory: src-tauri
        env:
          PKG_CONFIG_PATH: /usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig
          PKG_CONFIG_ALLOW_SYSTEM_LIBS: 1
          PKG_CONFIG_ALLOW_SYSTEM_CFLAGS: 1
        run: cargo tauri build
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: timeline-studio-${{ matrix.os }}
          path: |
            src-tauri/target/release/bundle/
            !src-tauri/target/release/bundle/**/.*